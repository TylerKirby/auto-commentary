\documentclass{article}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{geometry}
\usepackage{multicol}
\usepackage{fancyhdr}
\usepackage{xcolor}
\usepackage{setspace}

% Greek character handling - basic approach
\DeclareUnicodeCharacter{03B1}{\ensuremath{\alpha}}
\DeclareUnicodeCharacter{03B2}{\ensuremath{\beta}}
\DeclareUnicodeCharacter{03B3}{\ensuremath{\gamma}}
\DeclareUnicodeCharacter{03B4}{\ensuremath{\delta}}
\DeclareUnicodeCharacter{03B5}{\ensuremath{\epsilon}}
\DeclareUnicodeCharacter{03B6}{\ensuremath{\zeta}}
\DeclareUnicodeCharacter{03B7}{\ensuremath{\eta}}
\DeclareUnicodeCharacter{03B8}{\ensuremath{\theta}}
\DeclareUnicodeCharacter{03B9}{\ensuremath{\iota}}
\DeclareUnicodeCharacter{03BA}{\ensuremath{\kappa}}
\DeclareUnicodeCharacter{03BB}{\ensuremath{\lambda}}
\DeclareUnicodeCharacter{03BC}{\ensuremath{\mu}}
\DeclareUnicodeCharacter{03BD}{\ensuremath{\nu}}
\DeclareUnicodeCharacter{03BE}{\ensuremath{\xi}}
\DeclareUnicodeCharacter{03BF}{\ensuremath{o}}
\DeclareUnicodeCharacter{03C0}{\ensuremath{\pi}}
\DeclareUnicodeCharacter{03C1}{\ensuremath{\rho}}
\DeclareUnicodeCharacter{03C2}{\ensuremath{\varsigma}}
\DeclareUnicodeCharacter{03C3}{\ensuremath{\sigma}}
\DeclareUnicodeCharacter{03C4}{\ensuremath{\tau}}
\DeclareUnicodeCharacter{03C5}{\ensuremath{\upsilon}}
\DeclareUnicodeCharacter{03C6}{\ensuremath{\phi}}
\DeclareUnicodeCharacter{03C7}{\ensuremath{\chi}}
\DeclareUnicodeCharacter{03C8}{\ensuremath{\psi}}
\DeclareUnicodeCharacter{03C9}{\ensuremath{\omega}}
% Handle common diacritics by ignoring them (basic fallback)
\DeclareUnicodeCharacter{0313}{}
\DeclareUnicodeCharacter{0314}{}
\DeclareUnicodeCharacter{0341}{}
\DeclareUnicodeCharacter{0342}{}
\DeclareUnicodeCharacter{0300}{}
\DeclareUnicodeCharacter{0301}{}
\DeclareUnicodeCharacter{0302}{}
\DeclareUnicodeCharacter{0303}{}
\DeclareUnicodeCharacter{0304}{}
\DeclareUnicodeCharacter{0306}{}
\DeclareUnicodeCharacter{0308}{}

% Page setup - slightly larger margins for readability
\geometry{letterpaper, margin=1in}
\pagestyle{fancy}
\fancyhf{}
\fancyhead[C]{{ "{{" }}{% if doc.metadata.title %}{{ doc.metadata.title }}{% else %}Commentary{% endif %}{{ "}}" }}
\fancyfoot[C]{\thepage}

% Custom formatting for text-with-glossary layout
\setlength{\parindent}{0pt}
\setlength{\parskip}{0.5em}

% Define styles for text and glossary
\newcommand{\latintext}[1]{\textbf{#1}}
\newcommand{\glossaryentry}[1]{\small #1}

\begin{document}

% Title page
{% if doc.metadata.title %}
\begin{center}
\Large\textbf{{ "{{" }}{{ doc.metadata.title }}{{ "}}" }}
\end{center}
\vspace{1em}
{% endif %}

% Render each page with interlinear format
{% for page in doc.pages %}

{% if not loop.first %}
\newpage
{% endif %}

% Page header
\begin{center}
\textbf{Page {{ page.number }}{% if page.lines %} (Lines {% for line in page.lines if line.number %}{{ line.number }}{% if not loop.last %}, {% endif %}{% endfor %}){% endif %}}
\end{center}
\vspace{0.5em}

% Text followed by same-page glossary
{% for line in page.lines %}
{% if line.number %}\textbf{{ "{{" }}{{ line.number }}{{ "}}" }} {% endif %}\latintext{{ "{" }}{{ line.text }}{{ "}" }}\\
{% endfor %}

\vspace{1em}

% Glossary for this page
{% set page_glossed_words = [] %}
\textbf{Glossary:}\\
{% for line in page.lines %}
{% for token in line.tokens %}
{% if token.gloss and token.analysis and token.analysis.lemma and not token.is_punct %}
{% set lemma_key = token.analysis.lemma | lower %}
{% if lemma_key not in page_glossed_words %}
{% set _ = page_glossed_words.append(lemma_key) %}
\glossaryentry{{ "{" }}\textbf{{ "{{" }}{{ token.analysis.lemma }}{{ "}}" }}: {{ token.gloss.best if token.gloss.best else "definition not found" }}{{ "}" }}\\
{% endif %}
{% endif %}
{% endfor %}
{% endfor %}

{% endfor %}

\end{document}