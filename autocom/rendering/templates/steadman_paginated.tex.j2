\documentclass{article}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{geometry}
\usepackage{multicol}
\usepackage{fancyhdr}
\usepackage{xcolor}

% Greek character handling - basic approach
\DeclareUnicodeCharacter{03B1}{\ensuremath{\alpha}}
\DeclareUnicodeCharacter{03B2}{\ensuremath{\beta}}
\DeclareUnicodeCharacter{03B3}{\ensuremath{\gamma}}
\DeclareUnicodeCharacter{03B4}{\ensuremath{\delta}}
\DeclareUnicodeCharacter{03B5}{\ensuremath{\epsilon}}
\DeclareUnicodeCharacter{03B6}{\ensuremath{\zeta}}
\DeclareUnicodeCharacter{03B7}{\ensuremath{\eta}}
\DeclareUnicodeCharacter{03B8}{\ensuremath{\theta}}
\DeclareUnicodeCharacter{03B9}{\ensuremath{\iota}}
\DeclareUnicodeCharacter{03BA}{\ensuremath{\kappa}}
\DeclareUnicodeCharacter{03BB}{\ensuremath{\lambda}}
\DeclareUnicodeCharacter{03BC}{\ensuremath{\mu}}
\DeclareUnicodeCharacter{03BD}{\ensuremath{\nu}}
\DeclareUnicodeCharacter{03BE}{\ensuremath{\xi}}
\DeclareUnicodeCharacter{03BF}{\ensuremath{o}}
\DeclareUnicodeCharacter{03C0}{\ensuremath{\pi}}
\DeclareUnicodeCharacter{03C1}{\ensuremath{\rho}}
\DeclareUnicodeCharacter{03C2}{\ensuremath{\varsigma}}
\DeclareUnicodeCharacter{03C3}{\ensuremath{\sigma}}
\DeclareUnicodeCharacter{03C4}{\ensuremath{\tau}}
\DeclareUnicodeCharacter{03C5}{\ensuremath{\upsilon}}
\DeclareUnicodeCharacter{03C6}{\ensuremath{\phi}}
\DeclareUnicodeCharacter{03C7}{\ensuremath{\chi}}
\DeclareUnicodeCharacter{03C8}{\ensuremath{\psi}}
\DeclareUnicodeCharacter{03C9}{\ensuremath{\omega}}
% Handle common diacritics by ignoring them (basic fallback)
\DeclareUnicodeCharacter{0313}{}
\DeclareUnicodeCharacter{0314}{}
\DeclareUnicodeCharacter{0341}{}
\DeclareUnicodeCharacter{0342}{}
\DeclareUnicodeCharacter{0300}{}
\DeclareUnicodeCharacter{0301}{}
\DeclareUnicodeCharacter{0302}{}
\DeclareUnicodeCharacter{0303}{}
\DeclareUnicodeCharacter{0304}{}
\DeclareUnicodeCharacter{0306}{}
\DeclareUnicodeCharacter{0308}{}

% Page setup
\geometry{letterpaper, margin=0.75in}
\pagestyle{fancy}
\fancyhf{}
\fancyhead[C]{{ "{{" }}{% if doc.metadata.title %}{{ doc.metadata.title }}{% else %}Commentary{% endif %}{{ "}}" }}
\fancyfoot[C]{\thepage}

% Custom formatting
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt}

\begin{document}

% Title page
{% if doc.metadata.title %}
\begin{center}
\Large\textbf{{ "{{" }}{{ doc.metadata.title }}{{ "}}" }}
\end{center}
\vspace{1em}
{% endif %}

% Render each page separately with its own glossary
{% for page in doc.pages %}

{% if not loop.first %}
\newpage
{% endif %}

% Text for this page
{% for line in page.lines %}
\noindent
{% if line.number %}\textbf{{ "{{" }}{{ line.number }}{{ "}}" }} {% endif %}
{{ line.text }}
\\[0.5em]
{% endfor %}

\vspace{1em}
\hrule
\vspace{1em}

% Glossary for ONLY this page's words
\begin{center}
\large\textbf{Glossary{% if page.number %} - Page {{ page.number }}{% endif %}
{% if page.lines and page.lines|map(attribute='number')|list|select %}
 (Lines {% for line in page.lines if line.number %}{{ line.number }}{% if not loop.last %}, {% endif %}{% endfor %})
{% endif %}
}
\end{center}

\begin{multicols}{2}
{% set page_glossed_words = [] %}
{% for line in page.lines %}
{% for token in line.tokens %}
{% if token.gloss and token.analysis and token.analysis.lemma not in page_glossed_words %}
{% set _ = page_glossed_words.append(token.analysis.lemma) %}

\textbf{{ "{" }}{{ token.analysis.lemma }}{{ "}" }}{% if token.analysis.pos_labels %} ({{ token.analysis.pos_labels[0] }}){% endif %}: {% if token.gloss.best %}{{ token.gloss.best }}{% else %}definition not found{% endif %}

{% endif %}
{% endfor %}
{% endfor %}
\end{multicols}

{% endfor %}

\end{document}