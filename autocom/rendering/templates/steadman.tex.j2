\documentclass{article}
\usepackage{fontspec}
\usepackage{geometry}
\usepackage{multicol}
\usepackage{fancyhdr}
\usepackage{xcolor}

% Use system fonts with full Unicode support (XeLaTeX)
\setmainfont{Times New Roman}[Ligatures=TeX]

% Page setup
{% if doc.metadata.paper_size == "a4" %}
\geometry{a4paper, margin=0.75in}
{% elif doc.metadata.paper_size == "a5" %}
\geometry{a5paper, margin=0.5in}
{% else %}
\geometry{letterpaper, margin=0.75in}
{% endif %}
\pagestyle{fancy}
\fancyhf{}
\fancyhead[C]{{ "{{" }}{% if doc.metadata.title %}{{ doc.metadata.title }}{% else %}Commentary{% endif %}{{ "}}" }}
\fancyfoot[C]{\thepage}

% Custom formatting
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt}

\begin{document}

{% if doc.core_vocabulary %}
% Core Vocabulary - words appearing 15+ times (learn these first!)
\begin{center}
\large\textbf{Core Vocabulary}
\end{center}
\vspace{0.5em}

\begin{multicols}{2}
{% for token in doc.core_vocabulary %}
{% set hw = token.gloss.headword or token.analysis.lemma %}
{% set has_definition = token.gloss.best %}
{% if has_definition %}
\textbf{{ "{" }}{{ hw | latex_escape }}{% if token.gloss.genitive %}, {{ token.gloss.genitive | latex_escape }}{% endif %}{{ "}" }}{% if token.gloss.gender %} \textit{{ "{" }}{{ token.gloss.gender }}{{ "}" }}{% elif token.gloss.pos_abbrev %} \textit{{ "{" }}{{ token.gloss.pos_abbrev }}{{ "}" }}{% endif %}{% if token.gloss.principal_parts %} ({{ token.gloss.principal_parts | latex_escape }}){% endif %}: {{ token.gloss.best | latex_escape }}{% if token.gloss.frequency %}, {{ token.gloss.frequency }}{% endif %}

{% else %}
\textbf{{ "{" }}{{ hw | latex_escape }}{{ "}" }}: definition not found

{% endif %}
{% endfor %}
\end{multicols}
\newpage
{% endif %}

% Render each page separately with its own glossary (excluding core vocabulary)
{% for page in doc.pages %}

{% if not loop.first %}
\newpage
{% endif %}

% Text for this page
{% for line in page.lines %}
{% set line_has_content = line.text.strip() %}
{% if line_has_content %}
\noindent
{% if line.number %}\textbf{{ "{{" }}{{ line.number }}{{ "}}" }} {% endif %}
{{ line.text | latex_escape }}
\\
{% else %}
\vspace{0.25em}
{% endif %}
{% endfor %}

\vspace{1em}
\hrule
\vspace{0.5em}

\begin{multicols}{2}
{% for token in page.lines | sorted_glossary %}
{% set hw = token.gloss.headword or token.analysis.lemma %}
{% set has_definition = token.gloss.best %}
{% if has_definition %}
\textbf{{ "{" }}{{ hw | latex_escape }}{% if token.gloss.genitive %}, {{ token.gloss.genitive | latex_escape }}{% endif %}{{ "}" }}{% if token.gloss.gender %} \textit{{ "{" }}{{ token.gloss.gender }}{{ "}" }}{% elif token.gloss.pos_abbrev %} \textit{{ "{" }}{{ token.gloss.pos_abbrev }}{{ "}" }}{% endif %}{% if token.gloss.principal_parts %} ({{ token.gloss.principal_parts | latex_escape }}){% endif %}: {{ token.gloss.best | latex_escape }}{% if token.gloss.frequency and token.gloss.frequency > 1 %}, {{ token.gloss.frequency }}{% endif %}

{% else %}
\textbf{{ "{" }}{{ hw | latex_escape }}{{ "}" }}: definition not found

{% endif %}
{% endfor %}
\end{multicols}

{% endfor %}

\end{document}
