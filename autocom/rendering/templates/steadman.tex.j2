\documentclass[11pt]{article}
\usepackage{fontspec}
\usepackage{geometry}
\usepackage{multicol}
\usepackage{fancyhdr}
\usepackage{xcolor}
\usepackage{setspace}

% Use system fonts with full Unicode support (XeLaTeX)
\setmainfont{Times New Roman}[Ligatures=TeX]

% Set line spacing for better readability
\setstretch{1.15}

% Page setup
{% if doc.metadata.paper_size == "a4" %}
\geometry{a4paper, margin=0.75in}
{% elif doc.metadata.paper_size == "a5" %}
\geometry{a5paper, margin=0.5in}
{% else %}
\geometry{letterpaper, margin=0.75in}
{% endif %}
\pagestyle{fancy}
\fancyhf{}
\fancyhead[C]{{ "{{" }}{% if doc.metadata.title %}{{ doc.metadata.title }}{% else %}Commentary{% endif %}{{ "}}" }}
\fancyfoot[C]{\thepage}

% Custom formatting
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt}

\begin{document}

{% if doc.metadata.title %}
% Title Page
\begin{titlepage}
\centering
\vspace*{2in}

{\LARGE\bfseries {{ doc.metadata.title | latex_escape }}\par}

{% if doc.metadata.author %}
\vspace{0.5in}
{\large {{ doc.metadata.author | latex_escape }}\par}
{% endif %}

{% if doc.metadata.passage_range %}
\vspace{0.3in}
{\large {{ doc.metadata.passage_range | latex_escape }}\par}
{% endif %}

\vspace{1in}
{\normalsize A Steadman-Style Commentary\par}

\vfill

{% if doc.metadata.commentary_author %}
{\small Commentary by {{ doc.metadata.commentary_author | latex_escape }}\par}
{% endif %}

\end{titlepage}
{% endif %}

{% if doc.core_vocabulary %}
% Core Vocabulary - words appearing 15+ times (learn these first!)
\begin{center}
\large\textbf{Core Vocabulary}
\end{center}
\vspace{0.5em}

\begin{multicols}{2}
\raggedright
\sloppy
\setlength{\parskip}{3pt}
{% for token in doc.core_vocabulary -%}
{% set hw = token.gloss.headword or token.analysis.lemma -%}
{% if token.gloss.best -%}
\textbf{{ "{" }}{% if token.gloss.article %}{{ token.gloss.article }} {% endif %}{{ hw | latex_escape }}{% if token.gloss.genitive %}, {{ token.gloss.genitive | latex_escape }}{% endif %}{{ "}" }}{% if not token.gloss.article %}{% if token.gloss.gender %} \textit{{ "{" }}{{ token.gloss.gender }}{{ "}" }}{% elif token.gloss.pos_abbrev %} \textit{{ "{" }}{{ token.gloss.pos_abbrev }}{{ "}" }}{% endif %}{% endif %}{% if token.gloss.principal_parts %} ({{ token.gloss.principal_parts | latex_escape }}){% endif %}: {{ token.gloss.best | latex_escape }}{% if token.gloss.first_occurrence_line %} ({{ token.gloss.first_occurrence_line }}){% endif %}

{% endif -%}
{% endfor -%}
\end{multicols}
\newpage
{% endif %}

% Render each page separately with its own glossary (excluding core vocabulary)
{% for page in doc.pages %}

{% if not loop.first %}
\newpage
{% endif %}

% Text for this page
{% for line in page.lines %}
{% set line_has_content = line.text.strip() %}
{% if line_has_content %}
\noindent
{% if line.number %}\llap{\makebox[2em][r]{\textbf{{ "{{" }}{{ line.number }}{{ "}}" }}}\hspace{0.5em}}{% endif %}{{ line.text | latex_escape }}
\\
{% else %}
\vspace{0.25em}
{% endif %}
{% endfor %}

\vspace{1em}
\hrule
\vspace{0.5em}

\begin{multicols}{2}
\raggedright
\sloppy
\setlength{\parskip}{3pt}
{% for token in page.lines | sorted_glossary -%}
{% set hw = token.gloss.headword or token.analysis.lemma -%}
\textbf{{ "{" }}{% if token.gloss.article %}{{ token.gloss.article }} {% endif %}{{ hw | latex_escape }}{% if token.gloss.genitive %}, {{ token.gloss.genitive | latex_escape }}{% endif %}{{ "}" }}{% if not token.gloss.article %}{% if token.gloss.gender %} \textit{{ "{" }}{{ token.gloss.gender }}{{ "}" }}{% elif token.gloss.pos_abbrev %} \textit{{ "{" }}{{ token.gloss.pos_abbrev }}{{ "}" }}{% endif %}{% endif %}{% if token.gloss.principal_parts %} ({{ token.gloss.principal_parts | latex_escape }}){% endif %}: {{ token.gloss.best | latex_escape }}{% if token.gloss.first_occurrence_line %} ({{ token.gloss.first_occurrence_line }}){% endif %}

{% endfor -%}
\end{multicols}

{% endfor %}

\end{document}
